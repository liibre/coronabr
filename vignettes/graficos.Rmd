---
title: "Visualização dos casos registrados de coronavírus no Brasil"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{figs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE, results = FALSE, 
                      comment = FALSE, 
                      fig.width = 5, 
                      fig.height = 5)
```


```{r pkgs}
devtools::load_all()
library(ggplot2)
library(dplyr)
library(rgdal)
library(sf)
library(tmap)
library(brazilmaps)
library(gganimate)
```


## Crescimento nacional no número de casos

```{r get}
dados <- get_corona_br(by_uf = TRUE)
dados_jhu <- get_corona_jhu()
br <- get_brmap(geo = "State",
                class = "sf")
```


```{r fig-casos, fig.width=6}
plot_corona_br(df = dados, log = FALSE)
```


## Entendendo o aumento diário

```{r fig-perc, fig.width=6, fig.height=7}
plot_corona_br(df = dados, tipo = "aumento")
```

## Número de casos por estado brasileiro

```{r mapa, message = FALSE}
# df_uf <- dados %>% 
#   group_by(uid, nome, date) %>%
#   summarise_at(vars(Casos), sum) %>%
#   ungroup() %>% 
#   dplyr::rename(State = uid) %>%
#   dplyr::mutate(log_cases = log(Casos + 1), 
#                 State = as.factor(State))
# 
# br_sf <- st_as_sf(br) %>%  
#   merge(df_uf)
#   
# mapa <- tm_shape(br_sf) +
#   tm_fill() +
#   tm_borders() +
#   #tm_shape() +
#   tm_symbols(size = "Casos", 
#              col = "red", 
#              border.col = "red",
#              scale = 2, 
#              alpha = 0.7)
# 
# mapa
#tm_facets(by = "date", free.coords = FALSE)
```

## Crescimento do número de casos nos estados mais afetados

```{r estados, fig.width=6}
# uf10 <- df_uf %>% 
#   filter(date == max(date), Casos > 9) %>%
#   select(State)
# fig_uf <- df_uf %>% filter(State %in% uf10$State) %>% 
#   mutate(nome = reorder(nome, -Casos)) %>% 
#   ggplot(aes(x = date, y = Casos, col = nome)) + 
#   geom_line() +
#   geom_point() +
#   labs(x = "Data", 
#        y = "Número de casos confirmados", 
#        title = "Estados com mais de 10 casos", 
#        fill = "UF") +
#   guides(color = guide_legend("UF")) +
#   scale_color_brewer(palette = "Set2") +
#   scale_x_date(date_breaks = "1 day", 
#                date_labels = "%d/%m") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90), 
#         legend.title = element_text(size = 7), 
#         legend.text = element_text(size = 7))
# fig_uf
```


```{r anim-estados, fig.width=6, fig.show="animate", eval=FALSE}
# pra expandir o eixo x 
# hoje_mais_5_dias <- as.Date(format(Sys.time(), "%Y-%m-%d")) + 5
# 
# anim_uf <- df_uf %>% filter(State %in% uf10$State) %>% 
#   mutate(nome = reorder(nome, -Casos)) %>% 
#   ggplot(aes(x = date, y = Casos, col = nome, group = nome)) + 
#   geom_line() +
#   geom_point() +
#   # parâmetros da animação começam aqui: {
#   transition_reveal(date) +
#   geom_segment(aes(xend = max(date), yend = Casos), linetype = 2) + 
#   geom_text(aes(x = max(date), label = nome), hjust = 0) +
#   coord_cartesian(clip = "off") +
#   # e terminam aqui: }
#   labs(x = "Data", 
#        y = "Número de casos confirmados", 
#        title = "Estados com mais de 10 casos", 
#        # aqui muda a data em cada frame:
#        subtitle = "Data: {frame_along}",
#        fill = "UF") +
#   guides(color = guide_legend("UF")) +
#   scale_color_brewer(palette = "Set2") +
#   scale_x_date(date_breaks = "1 day", 
#                date_labels = "%d/%m") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90), 
#         legend.title = element_text(size = 7), 
#         legend.text = element_text(size = 7)) +
#   expand_limits(x = as.Date(hoje_mais_5_dias))

# ainda nao sei salvar
# animate(anim_uf, fps = 10, width = 750, height = 450)
# anim_save("figs/anim_uf.gif")

```


## Evolução do número de casos por estado

```{r facet-map}
# df_date <- dados %>% 
#   group_by(uid, date) %>%
#   summarise_at(vars(Casos), sum) %>%
#   dplyr::rename(State = uid) #%>%
#   #dplyr::mutate(cases = log(cases + 1))
# 
# date_sf <- st_as_sf(br) %>%  
#   merge(df_date)
# 
# all_map <- tm_shape(br) +
#   #tm_fill(col = "white") +
#   tm_borders() +
#   tm_polygons() +
#   #br_sf %>%  merge(df_date) %>%
#   tm_shape(date_sf) +
#   tm_fill() +
#   tm_borders() +
#   tm_symbols(size = "Casos",
#              border.col = "red", 
#              col = "red", 
#              scale = 1, 
#              alpha = 0.7) +
#   tm_facets(by = "date", free.coords = FALSE)
```


```{r anim, eval = T, fig.show = "animate"}
# anim <- tm_shape(br) +
#   tm_borders() +
#   tm_polygons() +
#   tm_shape(date_sf) +
#   tm_symbols(size = "Casos",
#              border.col = "red", 
#              col = "red",
#              scale = 2,
#              alpha = 0.7) +
#   tm_facets(along = "date", free.coords = FALSE)

# tmap::tmap_animation(anim, filename = "figs/anim.gif", delay = 25, 
#                width = 1200, height = 1200, res = 300)
```

<img src="https://raw.githubusercontent.com/liibre/coronabr/master/vignettes/figs/anim.gif" align="center" alt="" width="600" />
